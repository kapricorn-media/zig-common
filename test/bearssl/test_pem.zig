const std = @import("std");
const expect = std.testing.expect;
const expectEqual = std.testing.expectEqual;
const expectEqualSlices = std.testing.expectEqualSlices;

const bssl = @import("zigkm-bearssl");
const pem = bssl.pem;

// TODO dupe in zig-http
fn hexDigitToNumber(digit: u8) !u8
{
    if ('0' <= digit and digit <= '9') {
        return digit - '0';
    } else if ('a' <= digit and digit <= 'f') {
        return digit - 'a' + 10;
    } else if ('A' <= digit and digit <= 'F') {
        return digit - 'A' + 10;
    } else {
        return error.BadDigit;
    }
}

fn hexStringToBytes(comptime string: []const u8) ![string.len / 2]u8
{
    comptime {
        if (string.len % 2 != 0) {
            @compileError("hex string length should be even");
        }
    }
    var bytes: [string.len / 2]u8 = undefined;
    var i: usize = 0;
    while (i < bytes.len) : (i += 1) {
        const digitHi = try hexDigitToNumber(string[i * 2]);
        const digitLo = try hexDigitToNumber(string[i * 2 + 1]);
        bytes[i] = (digitHi << 4) + digitLo;
    }
    return bytes;
}

const Param = struct {
    data: []const u8,
    expected: [][]const u8,
    index: usize,
};

fn callback(param: *Param, data: []const u8) !void
{
    try expect(param.index < param.expected.len);
    try expectEqualSlices(u8, param.expected[param.index], data);
    param.index += 1;
}

test "PEM"
{
    var gpa = std.heap.GeneralPurposeAllocator(.{}){};
    defer expect(!gpa.deinit()) catch |err| std.log.err("{}", .{err});
    var allocator = gpa.allocator();

    var params = [_]Param {
        .{
            .data = @embedFile("localhost.crt"),
            .expected = &[_][]const u8 {
                &(try hexStringToBytes("308202e5308201cda003020102020900c21d8ecd645c9768300d06092a864886f70d01010b050030143112301006035504030c096c6f63616c686f7374301e170d3231313232353230333435345a170d3232303132343230333435345a30143112301006035504030c096c6f63616c686f737430820122300d06092a864886f70d01010105000382010f003082010a0282010100ba684923bfd1f263425d450edeaf263064a63215781b00951d2161f18a0fa28502a6aa76aaa926a9cc0e6d761c4c3903473251c269cc9a29791a931f5c3d8d311d73ca949dd42836a1f4042e4dddedc99a1d1958c879215c37976e4349f6d2dd989a48259c3c3afa6cd0f72b6a53cd2559d8f6f9a5c1159eb96411c5a80a3bf599266df4f43cf0ef264067d3599096fd11cd1998c59dd0a6049e7902775cdb097c770536f92930581abf4301bfea56880320aef377577cbe38ab313a3fcc036330106c7fbec24d49c4d66db3b6bf56a9f0164de9302bae60db019b79cd5f525223e6a31a64dced62f8de2d1857120966dbd3520351f6c60c66db38ed031253a10203010001a33a303830140603551d11040d300b82096c6f63616c686f7374300b0603551d0f04040302078030130603551d25040c300a06082b06010505070301300d06092a864886f70d01010b0500038201010093424646acebad31b73681efd49170e4cc0fb70a3e62d5b76b99323d492f26d6e460ca877ffddf6f1cb5e2165dacd13987d12894b9cfcaf2d3aee50f1a3a1c6d78eed1fb9945bacf403989f65f18fb00fdb28227a36242d92b3120718d4cc7bc44c2a09294111118604fd0028b0f2662532a259d537a137211fad007f96d74556eaecbb771e09ff824b745643a5495741a0c782620d97a0500eb24aef18a0ea6a90ed3845774455e8bf2bd5778597e6573c9803863c91098c98a62b75d7d6980df15e9bee605ff47b0524835bfdd6eebbab218ebf7b9689956c42811cfe814598e2c17415f8eb4e143f8c0a2e9fc74f846f719cda8556d4d1b23eeef70c65914")),
            },
            .index = 0,
        },
        .{
            .data = @embedFile("localhost.key"),
            .expected = &[_][]const u8 {
                &(try hexStringToBytes("308204be020100300d06092a864886f70d0101010500048204a8308204a40201000282010100ba684923bfd1f263425d450edeaf263064a63215781b00951d2161f18a0fa28502a6aa76aaa926a9cc0e6d761c4c3903473251c269cc9a29791a931f5c3d8d311d73ca949dd42836a1f4042e4dddedc99a1d1958c879215c37976e4349f6d2dd989a48259c3c3afa6cd0f72b6a53cd2559d8f6f9a5c1159eb96411c5a80a3bf599266df4f43cf0ef264067d3599096fd11cd1998c59dd0a6049e7902775cdb097c770536f92930581abf4301bfea56880320aef377577cbe38ab313a3fcc036330106c7fbec24d49c4d66db3b6bf56a9f0164de9302bae60db019b79cd5f525223e6a31a64dced62f8de2d1857120966dbd3520351f6c60c66db38ed031253a10203010001028201002fcafb2daa49c6eec21e2dcd9134b102e95b5f2df7fc5c5adefc272389b55682e9da178c9357092db1bee53bca2794da8d4f8e7cdd2973413ce69e600503570707b91f709942c308b6df5c8f0eb1defcb881cb74e2f9839f2435b434966b2d47598ffcfd7fa045b2dd617a6dec360e3c0c5c3f7e648c2be1e5408df9f28aa5327333d77b0356a90651c7c9a733dd94bbcc994e3ce53f1d62cb395270c6070befda4bf862a26f68c80a975268435bd6671c52cb2d37be95bca7fe55934c6c5870097d13fcb30b7465e90bfc901cd4a17ace14029793cb97b98c900e9303df9f6d4ca892e9871b34877d0530fdc59cda34dca9acf66447d2db459255690bf9f3bd02818100f6fb1810dfa491fb21c8f73a72ecbbf25ea0cd5db86b357d57f10eb8108e14599aac9a4b7bcad7942f6ea1bb276a27338bccf53e1fc092d479e273b2769f40d9bef15ff1958f0aaf50319020e48bf6d4b3104042ff325dba0c77b0aff853451b67ca19cdc1c4e8376510ac5047aa2efb201ae49bec7986b7d74d3ff1e192018302818100c136eb525b5a6eff10e987ec3b04512019bc69635b62ade6587c262bfc1248dc0f9f13ee91eb9efe5757ed8131cc2ad617c5b1928f9ceca2f358a90779399afec92e1440a87965a785540c3ceb05e45bdd68c4b1798d789ca00bdf6fdc4a15e248a8e42190ff8ec7e248f8690340ea126907a44bc17a270b2e4093c058ce410b028181009b3a3967f187d790452dafe4f6723fb6172f6da3a7d309ed5ba6501ff397b8c69066471b861478e5d3e1ee98582f69b005ffad6b7c3d668b5087b93bc33e585e029a6638ca4cfae430bcd5df3685997f1983ef3fac711563678e9a681ee5071c30615f5268a4bf668188b72445c67a7caf32f7d7e00a8957666450fa4f519acd02818100bc788de3b028eecceffa5d141a1d83e50435bdb7a595047d05235538e292137055ec9eccc09a4e655b5df1d76c73f3f5130b4cc3e242f8b19b1e89033944efe448ea21e7506fdab126656dea9e7708e2737f971e67ab905377eb1cf148b91bcfb780c7c7d660f32e1795867b2929512ad4391812ad903235bdd0504ff8507931028180281081e503ffaec93d017b66f3b5ddd1a1bd363e646afa1a522f4edcd1312e266c5798f41340e728459aed31a3eaf9da8c7cd8662d48838dd606d18562d7a245ca890d930533e19499df34aca3055e8967d5bf4b2f9b09a28c0e6dcf7e7b1be17921b00b0ae27328de4c86e82fe04589a9cb6d16f665fa74091dedeac49b5126")),
            },
            .index = 0,
        },
        .{
            .data = @embedFile("five_certs.pem"),
            .expected = &[_][]const u8 {
                &(try hexStringToBytes("30820614308203fca003020102020853ec3beefbb2485f300d06092a864886f70d01010505003051310b30090603550406130245533142304006035504030c394175746f72696461642064652043657274696669636163696f6e204669726d6170726f666573696f6e616c2043494620413632363334303638301e170d3039303532303038333831355a170d3330313233313038333831355a3051310b30090603550406130245533142304006035504030c394175746f72696461642064652043657274696669636163696f6e204669726d6170726f666573696f6e616c204349462041363236333430363830820222300d06092a864886f70d01010105000382020f003082020a0282020100ca966b8eeaf8fbf1a235e07f4cdae0c352d77db610c8025eb3432ac44f6ab2ca1c5d289a78111a695957afb52042e48b0fe6df5ba603922ff511e462d7327138d9040c71ab3d517e0f07df63055ce9bf946fc12982c0b4da51b0c13cbbad374a5ccaf14b360e24abbfc38477fda850f4b1e7c62fd22d598d7a0a4e96695202aa3698ecfcfa14830c371fc992377fd7812de5c4b9e03e34fe67f43e66d1d3f440cf5e62340f70063e20185acef7721b256c93741493a373b10eaa871023595f20051947ed688e9212ca5dfcd62bb2923c20cfe15faf20bea0767f76e5ec1a8661333ee77bb43fa00f8ea2b96a6fb987266f416c88a650fd6a630bf593161b198fb2ed9b9bc990f5010cdf193d0f3e3823c92f8f0cd102fe1b55d64ed08d3caf4fa4f3feaf2ad3059d7908a1cb5731b49cc890b267f41816933afc47d8d17896311fba2b0c5f5d99ad63895a242076d8dffdab4ea622aa9d5ee6278a7d6829a3e78ab8da11bb172d999d132446f7c5e2d89f8e7fc78f746d5ab2e872f5acee2410ad2f14daff2d9a467147be42dfbb01dbf47fd3288f31595bd3c902a6b452ca6e97fb43c508266f8af4bbfd9f28aa0dd545f3133a1dd8c0788f41673c1e9464ae7b0bc5e8d90188391a97866441d53b870c6efa0fc6bd4814bf394dd49e41b68f961d639693d995067831689e37063b808945613923c71b44a315e51cf89230bb0203010001a381ef3081ec30120603551d130101ff040830060101ff020101300e0603551d0f0101ff040403020106301d0603551d0e0416041465cdebab351e003e7ed574c01cb473470e1a642f3081a60603551d2004819e30819b3081980604551d200030818f302f06082b060105050702011623687474703a2f2f7777772e6669726d6170726f666573696f6e616c2e636f6d2f637073305c06082b0601050507020230501e4e0050006100730065006f0020006400650020006c006100200042006f006e0061006e006f00760061002000340037002000420061007200630065006c006f006e0061002000300038003000310037300d06092a864886f70d01010505000382020100177da0f9b4ddc5c5ebad4b24b5a102abdda5884ab20f554b2b578c3be531ddfec432f1e75b6496363218eca53277d7e344b6c0112a80b93d6a6e7c9bd3adfcc3d6a3e664297cd1e1381e822bff2765affb1615c42e7184e5b5fffaa447bd6432bbf62584a22742f520b0c2131011cd1015ba42902ad244e19626eb314812fd2adac906cf741ea94bd58728f97934923e2e44e8f68f4f8f353f25b339dc632a906b205fc452124e972c2aac9d97de48f2a366dbc2d28395a666a79e250fe90b3391650a5ac3d95412ddafc34e0e1f265e0ddcb38decd58170ded24f2405f36c4ef54c49668dd1ffd20b254148fe5184c642af8004cfd07e6449e4f2dfa2ecb14cc02a1de7b4b165a2c4bcf198f4aa700763b4b8da3b4cfa4022305b11a6f0050ec6020348ab869b85dddbddeaa27680737df59c04c4458de7b91c8b9eead775d172b1de7544e7427de2576b7ddc99bc3d8328ea80938dc54c65c17081b838fc4331b2f6033447b2acfb2206cb1edd17471c5f66b9d31aa2da11b1a4bc23c9e4be87ffb994b6f85d204ad45fe7bd687b65f2151ed23aa92de9d86b24ac97584447ad5918f1216570dece3460a840f1f33ca4c328238cfe27334340a0173cebea3bb072a6a3b94a4b5e1648f4b2bcc88c92c59d9fac7236bc3480346ba98b92c0b817edec7653f524018cb322e84b7c55c69dfaa314bb65856e6e4f127e0a3c9d95")),
                &(try hexStringToBytes("3082074f30820537a003020102020900a3da427ea4b1aeda300d06092a864886f70d01010505003081ae310b3009060355040613024555314330410603550407133a4d616472696420287365652063757272656e742061646472657373206174207777772e63616d65726669726d612e636f6d2f61646472657373293112301006035504051309413832373433323837311b3019060355040a131241432043616d65726669726d6120532e412e31293027060355040313204368616d62657273206f6620436f6d6d6572636520526f6f74202d2032303038301e170d3038303830313132323935305a170d3338303733313132323935305a3081ae310b3009060355040613024555314330410603550407133a4d616472696420287365652063757272656e742061646472657373206174207777772e63616d65726669726d612e636f6d2f61646472657373293112301006035504051309413832373433323837311b3019060355040a131241432043616d65726669726d6120532e412e31293027060355040313204368616d62657273206f6620436f6d6d6572636520526f6f74202d203230303830820222300d06092a864886f70d01010105000382020f003082020a0282020100af00cb70372b805a4a3a6c78947da37f1a1ff635d5bddbcb0d44723e26b29052ba633b28586fa5b36d94a6f3dd640c55f6f6e7f22222805ee162c6b629e1816cf2bfe57d326a54a0321959fe1f8bd73d608685246fe311b3773e209635216bb308d9702e64f7849253d60eb0908a8ae3878d06d3bd900ee299a11b860eda9a0abb0b61500652f19e7f76eccb0fd01e0dcf99303d1cc4451058acd6d3e8d7e5eac5010777d651e6037f8a48a54d6875b9e9bc9e4e1971f5324b9c6d60190bfbcc9d75dcbf26cd8f93783979735e250eca5ceb771207cb6441477293ab50c3eb09766434d239b77611090d7645c4a9ae3d6aafb57d652f945810ec5c7caf7ee2b618d9d09b4e5a49dfa9660bcc3cc6787ca79c1de3ce8e53be05de600f6be51adb3fe3e121c929c1f1eb079c521b0144513c7b25d7c4e552545d2507ca1620b8ade441ee7a08fe996f83a69102b06c36556ae77df596e6ca81d697f19483e9edb0b16b12691eacfb5da9c598e9b45b587abe3da2443a6359d40b25de1b4fbde5019ecdd229d59f17190a6fbf0c90d3095fd9e38a35cc795a4d193792b7c4c1adaff479249ab2010bb1af5c96f38032fb5c3d98f1a03f4adebeaf942ed9559a176e609d636cb863c9ae815c1835e090bbbe3c4f3722b97eebcf9e7721a63d3881fb48da313d2be389f5d0b5bd7ee050c41289b3239a103185dbae6fef38331876110203010001a382016c3082016830120603551d130101ff040830060101ff02010c301d0603551d0e04160414f924ac0fb2b5f879c0fa60881bc4d94d029e17193081e30603551d230481db3081d88014f924ac0fb2b5f879c0fa60881bc4d94d029e1719a181b4a481b13081ae310b3009060355040613024555314330410603550407133a4d616472696420287365652063757272656e742061646472657373206174207777772e63616d65726669726d612e636f6d2f61646472657373293112301006035504051309413832373433323837311b3019060355040a131241432043616d65726669726d6120532e412e31293027060355040313204368616d62657273206f6620436f6d6d6572636520526f6f74202d2032303038820900a3da427ea4b1aeda300e0603551d0f0101ff040403020106303d0603551d200436303430320604551d2000302a302806082b06010505070201161c687474703a2f2f706f6c6963792e63616d65726669726d612e636f6d300d06092a864886f70d010105050003820201009012af2235c2a339f02edee9b5e9787c48be3f7d45925ee9dab119fc163c9fb45b669e6ae7c3b95d88e80fadcf230fde253a5ecc4fa5c1b52dac24d25807dea2cf69846033e8100d13a923d085e58e7ba69e3d72137233f5aa7dc6631f08f4fe017f24cf2b2c5409dee22b6d92c6394f16ea3c7e7a46d4456a46a8eb758256a7aba07c681333f69d30f06f273924232a90fd902935f293df34a5c6f7f8ef8c0f624a7caed3f554f88db69a568716823a33ab5a2208f782baea2ee0479ab4b545a3053bd9dc2e45403beadc7fe83bebd1ec26d835a430c53aac579eb376a5207bf91e4a056201a628756097920d6e3e4d37430d92159c1822cd5199a0291a3c5f8a32335b30c7892f47980fa303c6f6f1acdf32f0d9811ae49cbdf68014f0d12cb985f5d8a3b1c8a521e51c1397ee0ebddf29a9ef34535bd3e46a138406b63202c452ae22d2dcb221421ada40f029c9ec0a0c5ce2d0bacc48d3370acc120a8a79b03d037f694bf434207db334ea8e4b64f53efdb32367150d04b8f02dc109513cb26c15f0a523d78374e4e52ec9fe982742c6abc69eb0d05b38a59b50de7e1898b5453bf679b4e8f71a7b0683fbd08bdabbc7bd18ab086f3c806b403f1919ba658ae6bed55cd336d7ef4052246038670431ec8ff382c6deb955f33b31915adcb50815ad76250a0d7b2e87e20ca606bc26106d379decdd788c7c80c5f0d97748d0")),
                &(try hexStringToBytes("3082074930820531a003020102020900c9cdd3e9d57d23ce300d06092a864886f70d01010505003081ac310b3009060355040613024555314330410603550407133a4d616472696420287365652063757272656e742061646472657373206174207777772e63616d65726669726d612e636f6d2f61646472657373293112301006035504051309413832373433323837311b3019060355040a131241432043616d65726669726d6120532e412e312730250603550403131e476c6f62616c204368616d6265727369676e20526f6f74202d2032303038301e170d3038303830313132333134305a170d3338303733313132333134305a3081ac310b3009060355040613024555314330410603550407133a4d616472696420287365652063757272656e742061646472657373206174207777772e63616d65726669726d612e636f6d2f61646472657373293112301006035504051309413832373433323837311b3019060355040a131241432043616d65726669726d6120532e412e312730250603550403131e476c6f62616c204368616d6265727369676e20526f6f74202d203230303830820222300d06092a864886f70d01010105000382020f003082020a0282020100c0df56d3e43a9b7645b413dbffc1b6198b374118955247eb179d29888e356c06322e4762f34904bf7d4436b171ccbd5a0973d5d98544ff915725df5e368e70d15c71431dd9daef5cd2fb1bbd3ab5cbada3cc44a70dae21153fb97a5b9275d8a4123889198ab780d2e2326f569c91d688100bb37464927460f3f6cf184f60b223d0c73bce614b998fc20cd040b298dc0da84ea3b90aae60a0ad455263ba66bd68e0f9be1aa881bb1e417875d3c1fe0055b08754e82790351d4c33ad97fc972e9884bf2cc9a3bfd1981114ed63f8ca9888581799ed4503977e3c861e888cbef291848f6534d8004c7db731175a297a0a182430a337b57aa9017d26d6f90e8e59f1fd1b33b5293b173b41b621ddd4c03da59f9f1f4350c9bbbc6c7a9798eecd8c1ffb9c51ae8b70bd279f71c06bac7d9066e8d75d3a0db0d5c28dd5c89d9dc16dd0d0bf51e4e3f8c33836aed6a775e6af84435d93920c6a07de3b1d9822d6acc135dba3a025ff72b5761dde6de92c662c5284d04592ce1ce5e5331ddc075354a3aa823b9a372fdcdda064e9e6ddbdaefc64851d3ca7c906de84ff6be86b1a3cc5a2b342fb8b093e5f0852c762c4d40571bfc464e4f8a183e83e129ba81ed4364d2f71f68d28f683a913d261c191bb48c0348f418c4b4cdb6912ff50949c20835973ed7ca1f2f1fdddf749d34358a05663ca3d3de5355659e90eca20cc2b4b93290f0203010001a382016a3082016630120603551d130101ff040830060101ff02010c301d0603551d0e04160414b909ca9c1edbd36c3a6baeed54f15b9306352e5e3081e10603551d230481d93081d68014b909ca9c1edbd36c3a6baeed54f15b9306352e5ea181b2a481af3081ac310b3009060355040613024555314330410603550407133a4d616472696420287365652063757272656e742061646472657373206174207777772e63616d65726669726d612e636f6d2f61646472657373293112301006035504051309413832373433323837311b3019060355040a131241432043616d65726669726d6120532e412e312730250603550403131e476c6f62616c204368616d6265727369676e20526f6f74202d2032303038820900c9cdd3e9d57d23ce300e0603551d0f0101ff040403020106303d0603551d200436303430320604551d2000302a302806082b06010505070201161c687474703a2f2f706f6c6963792e63616d65726669726d612e636f6d300d06092a864886f70d0101050500038202010080887f70de9228d9059446ff9057a9f12fdf1a0d6bfa7c0e1c49247927d846aa6f295952887012eadd3df59b53546fe160a2a809b9eceb597cc635f1dc18e9f167e5afba45e009deca440fc2170e7791457a335f5f962c688bc1478f989b3dc0eccbf5d582928435d1be36385672315b472daa17a46351eb0a01ad7fec759ecba11ff17f12b1b9e4647f67d6232af4b8395d98e821a7e1bd3d421a749a70af686c505d49cffffb0e5de62c47d7813a5900b5736b6320f6314508390ef4707e40705a3fd06b42a9743d282f026d757295098d4863c6c6235792935e35c18df90af72c9d621cf6ad7cdda6311eb6b1c77e8526faa46ab5da6330d1ef9337b2662f7d05f7e7b74b989435c0d93a29c19db250331d4aa95aa6c903efedf4e7a86e8ab45784eba43fd0eeaaaa875b63e893e26ba8d4b872786b1bed39e45dcb9baa87d54f4e00fed96a9f3c310f2802017d98e8a7b0a2649e79f848f215a9cce6c844eb3f7899f27b713e3cf198a7c518123fe6bb283342e9450a7c6df286792fc582197d09897cb2547688aedec1f3cce16edb31d693ae99a0ef256a7398895b3a2e13881ebfc09294341be327b78b1e6f42ffe7e9379b501d2da2f902eecb58583a71bc68e3aac1af1c281fa2dc23653f81eaae99d3d830cf130d4f15c984bca7482df8302377d8464b796df68ced3a7f601178f4e99baed554c07480d10b429fc1")),
                &(try hexStringToBytes("308207d3308205bba00302010202085ec3b7a6437fa4e0300d06092a864886f70d010105050030423112301006035504030c09414343565241495a313110300e060355040b0c07504b4941434356310d300b060355040a0c0441434356310b3009060355040613024553301e170d3131303530353039333733375a170d3330313233313039333733375a30423112301006035504030c09414343565241495a313110300e060355040b0c07504b4941434356310d300b060355040a0c0441434356310b300906035504061302455330820222300d06092a864886f70d01010105000382020f003082020a02820201009ba9abbf614a97af2f97669a745fd0d996fdcfe2e466ef1f1f4733c244a3df9ade1fb554dd157c6935116fbbc80c8e6a181ed88fd916bc1048365cf063b3905a5c2437d7a3d6cb0971b9f1017284b07ddb4d80cdfcd36fc9f8dab60e82d24585a81b68a83de8f4446cbda1c2cb03be8c3e130084df4a48c0e3220ae8e937a7184cb1090d23567f044dd9178418a5c8da409473ebce0e573c03813a9d0aa1574369ac576d799078e5b5b43bd8bc4c8d28a1a7a3a7ba024e25d12aaeedae0322b86b200f302854957fe0eece0a669dd1402d6e22af9d1ac10519d26fc0f29ff87bb30242fb50a91d2d930f23abc6c10f92ffd0a215f55309711cff451384e6265ef8e0881c0afc16b6a87306b8f0638402a0c65aece774df70aea38325ead6c7978793a7c68a8a33976037103e973e6e2915d6a10fd1882c129f6faaa4c642eb41a2e39543d301856d8ebb3bf32336c7fe3be0a1250748abc98974ff088f80bfc09665f3eeec4b68bd9d88c331b340f1e8cff638bb9ce4d17fd4e5589b7cfad4f30e9b7591e4ba522e197ed1f5cd5a19fcba06f6fb52a84b9904ddf8f9b48b50a34e6289f08724fa8342c187fad52d292a5a717a646ad72760630ddbce49f58d1f90893217f87343b8d25a938661d6e1750aea796676884f71eb0425d60a5a7a93e5b94b17400fb1b6b9f5de4fdce0b3ac3b117060844a436e9920c029710ac0650203010001a38202cb308202c7307d06082b060105050701010471306f304c06082b060105050730028640687474703a2f2f7777772e616363762e65732f66696c6561646d696e2f4172636869766f732f636572746966696361646f732f7261697a61636376312e637274301f06082b060105050730018613687474703a2f2f6f6373702e616363762e6573301d0603551d0e04160414d287b4e3df37279355f656ea81e536cc8c1e3fbd300f0603551d130101ff040530030101ff301f0603551d23041830168014d287b4e3df37279355f656ea81e536cc8c1e3fbd308201730603551d200482016a30820166308201620604551d2000308201583082012206082b06010505070202308201141e820110004100750074006f0072006900640061006400200064006500200043006500720074006900660069006300610063006900f3006e00200052006100ed007a0020006400650020006c00610020004100430043005600200028004100670065006e0063006900610020006400650020005400650063006e006f006c006f006700ed00610020007900200043006500720074006900660069006300610063006900f3006e00200045006c006500630074007200f3006e006900630061002c002000430049004600200051003400360030003100310035003600450029002e002000430050005300200065006e00200068007400740070003a002f002f007700770077002e0061006300630076002e00650073303006082b060105050702011624687474703a2f2f7777772e616363762e65732f6c656769736c6163696f6e5f632e68746d30550603551d1f044e304c304aa048a0468644687474703a2f2f7777772e616363762e65732f66696c6561646d696e2f4172636869766f732f636572746966696361646f732f7261697a61636376315f6465722e63726c300e0603551d0f0101ff04040302010630170603551d110410300e810c6163637640616363762e6573300d06092a864886f70d010105050003820201009731029fe7fd4367484414e42987ed4c2866d08f35da4d61b74a974db5db90e0052e0ec679d0f297690fbd0447d9bedbb529da9bd9aea999d5d33c3093f58da1a8fc068d44f4ca16957c33dc628ba837f827d8092d1befc8142720a96444ff2ed675aa6c4d60401949435463dae2ccba66e54f447a5bd96a812b40d57ff90127582cc8ed48917c3fa600cfc429731136de86193e9dee198a1bd5b0ed8e3d9c2ac00dd83d66e33c0dbdd5945ce2e2a7351b0400f63f5a8dea43bd5f891da9c1b0cc99e24d000adac9275be713905ce4f533a2556ddce0094d2fb1265b27750009c4627729085f9e59acb67ead9f54302203c11e7164fef9380a9618dd0214ac23cb061c1ea47d8d0dde2741e8adda15b7b023dd2ba8d3da2587ede855444d88f4367e849a78acf70e56490ed63325d68450426c20121d2ad5bebcf27081a47060be05b59b9e0444be6123ace9a5248c1180945aa2a2b949d2c1dcd1a7ed31112c9e19a6eee155e1c0eacf0d84e417b7a27ca5de552506eeccc0875c40dacc953f55e035c7b884beb45dcd7a830172ee87e65f1daeb585c626dfe6c19ae91e02479f2aa86da95bcfec45777f98279a325d2ae384eec598662f96201dddd8c327d7b0f9fed97dcdd09f8f0b1458519f2f8bc3382ddee88fd68d87a4f5564316992cf4a456b434b86137c9c258801ba097a1fc598de911f6d10f4b5534462a8b863b")),
                &(try hexStringToBytes("308205bb308203a3a0030201020208570a119742c4e3cc300d06092a864886f70d01010b0500306b310b3009060355040613024954310e300c06035504070c054d696c616e31233021060355040a0c1a416374616c697320532e702e412e2f30333335383532303936373127302506035504030c1e416374616c69732041757468656e7469636174696f6e20526f6f74204341301e170d3131303932323131323230325a170d3330303932323131323230325a306b310b3009060355040613024954310e300c06035504070c054d696c616e31233021060355040a0c1a416374616c697320532e702e412e2f30333335383532303936373127302506035504030c1e416374616c69732041757468656e7469636174696f6e20526f6f7420434130820222300d06092a864886f70d01010105000382020f003082020a0282020100a7c6c4a529a42cefe518c5b050a36f513b9f0a5ac9c248380ac21ca0187f91b587b9403fdd1d681f0883d52d1e88a0f88f568f6d9902929016d55f086c89d7e1acbc20c2b1e083518a694d00965a6f2fc0447ea30ee491cd58eedcfbc71e4547dd27b908019fa6211df5412d2f4cfd28ade08aad22b456658e86548f934329de394678a33023bacdf07d1357c05dd2836b484cc4ab9f805a5b3abdc9a7223f8027335b0eb78a0c5d073708cb6cd27a47224435c5cccc2e8edd2aedb77d660d5f615122551be346e3e33dd035629adbaf14c85ba1cc891be13026fca09b1f81a7471f04eba33992069f99d3bfd3ea4f509c19fe96871e3c65f6a31824838610e7543ea83a76244f8121c5e30f02f893944720bbfed40ed368b9ddc47a8482e3535479dddb9cd2f2079b2eb6bc3eed856def2511f2971a4261f74a97e88bb11007fa6581b2a239cff73cff18fbc6f15a8b59e202ac7b92d04e144f5945f60c5e285fb0e83f45cfcfaf9b6ffb84d3775a956fac94849eeebcc04a8f4a93f84421e2314561504e10d8e3357c4c19b4de05bfa3069fc8b5cde41fd717060d7a9574550d681afc101b62649d6de095a0c39407570d14e6bd05fbb89fe6df8be2c6e77e96f653c58034502858f01250711730bae67863bcf4b2ad9b2bb2fee1398c5eba0b2094de7b83b8ffe3568db711e93b8cf2b1c15d9da40b4c2bd9b218f5b59f4b0203010001a3633061301d0603551d0e0416041452d8883ac89f7866ed89f37b387094c9020236d0300f0603551d130101ff040530030101ff301f0603551d2304183016801452d8883ac89f7866ed89f37b387094c9020236d0300e0603551d0f0101ff040403020106300d06092a864886f70d01010b050003820201000b7b7287c060a6494c8858e61d88f7146448a6d8580a0e4f1335df351dd4ed0631c8813e6ad5dd3b1a32ee903d11d22ef48ec3632e2366b067be6fb6c0133960aaa23425937552dea79dad0e878952716a163c191d83f89a2965bef43f9ad9f0f35a872171804dcbe0389b3fbbfae0304dcf86d365101918d19702b12b724268aca0bd4e5ada18bf6b9881d0fd9abe5e1548cd1115b9c0295cb4e888f73e36aeb762fd1e62de7078101c485bdabca438ba67ed553e5e57dfd403404c81a4d24f63a709420914fc00a9c280734f2ec040d9117b48ea7a02c0d3eb2801265874c1c073226d9395fd397dbb2ae3f682e32c975f4e1f9194fafe2ca3d8761ab84db2384f9bfa1d48607926e2f3fda9d09ae8708f497ad6e5bd0a0edb2df38dbfebe3a47dcbc79571e8daa37cc5c2f87492041b86aca4225340b6acfe4c76cffb9432c0359f763f6ee5906ea0a626a2b82cbed12b85fda768c8ba012bb16c741db87395e7eeb7c725f0004c00b27eb60b8b1cf3c0509e25b9e008de3666ff37a5d1bb54642cc927b54b927e65ffd32de1b94ebc7fa44121904177a6391fea9ee39fd0666f05ecaa767ebf6b16a0ebb5c7fc92542f2b11272537784c516ab0f3cc585d14f16a4815ffc207b6b18d0f8e5c5046b33dbf01984fb25954473e347b786d56932e73ea662878cd1d14bfa08f2f2eb82e8ef2148acce9b57cfb6c9d0ca5e196")),
            },
            .index = 0,
        },
    };

    for (params) |_, i| {
        try pem.decode(params[i].data, *Param, &params[i], callback, allocator);
        try expectEqual(params[i].index, params[i].expected.len);
    }
}
